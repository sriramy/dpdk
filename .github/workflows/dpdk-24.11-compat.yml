name: DPDK 24.11 Compatibility Test

on:
  push:
    paths:
      - 'lib/sampler/**'
      - '.github/workflows/dpdk-24.11-compat.yml'
  pull_request:
    paths:
      - 'lib/sampler/**'
      - '.github/workflows/dpdk-24.11-compat.yml'
  workflow_dispatch:

defaults:
  run:
    shell: bash --noprofile --norc -exo pipefail {0}

jobs:
  dpdk-24-11-compat:
    name: Build Sampler Against DPDK 24.11
    runs-on: ubuntu-22.04
    env:
      CCACHE_DIR: $HOME/.ccache
      DPDK_VERSION: v24.11

    steps:
    - name: Checkout sampler sources
      uses: actions/checkout@v4
      with:
        path: sampler-repo

    - name: Generate cache keys
      id: get_ref_keys
      run: |
        echo 'ccache=ccache-ubuntu-22.04-dpdk24.11-'$(date -u +%Y-w%W) >> $GITHUB_OUTPUT
        echo 'dpdk=dpdk-24.11-build' >> $GITHUB_OUTPUT

    - name: Retrieve ccache cache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ steps.get_ref_keys.outputs.ccache }}-${{ github.ref }}
        restore-keys: |
          ${{ steps.get_ref_keys.outputs.ccache }}-

    - name: Retrieve DPDK 24.11 build cache
      id: dpdk-cache
      uses: actions/cache@v4
      with:
        path: dpdk-24.11
        key: ${{ steps.get_ref_keys.outputs.dpdk }}

    - name: Update APT cache
      run: sudo apt update || true

    - name: Install build dependencies
      run: |
        sudo apt install -y \
          build-essential \
          ccache \
          libnuma-dev \
          meson \
          ninja-build \
          pkg-config \
          python3-pip \
          python3-pyelftools

    - name: Clone and build DPDK 24.11
      if: steps.dpdk-cache.outputs.cache-hit != 'true'
      run: |
        git clone --depth 1 --branch ${{ env.DPDK_VERSION }} https://github.com/DPDK/dpdk dpdk-24.11-src
        cd dpdk-24.11-src
        meson setup build \
          --prefix=$HOME/dpdk-24.11 \
          -Dexamples= \
          -Dtests=false \
          -Ddisable_drivers=* \
          -Dmax_numa_nodes=1
        ninja -C build
        ninja -C build install
        cd ..
        rm -rf dpdk-24.11-src

    - name: Set PKG_CONFIG_PATH for DPDK 24.11
      run: |
        echo "PKG_CONFIG_PATH=$HOME/dpdk-24.11/lib/x86_64-linux-gnu/pkgconfig:$HOME/dpdk-24.11/lib/pkgconfig" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=$HOME/dpdk-24.11/lib/x86_64-linux-gnu:$HOME/dpdk-24.11/lib" >> $GITHUB_ENV

    - name: Verify DPDK 24.11 installation
      run: |
        pkg-config --modversion libdpdk || true
        ls -la $HOME/dpdk-24.11/lib/ || true
        ls -la $HOME/dpdk-24.11/lib/x86_64-linux-gnu/ || true

    - name: Copy sampler library to DPDK 24.11
      run: |
        cd dpdk-24.11
        # Create sampler directory structure
        mkdir -p lib/sampler
        cp -r $GITHUB_WORKSPACE/sampler-repo/lib/sampler/* lib/sampler/
        
        # Update lib/meson.build to add sampler after eventdev
        if ! grep -q "sampler" lib/meson.build; then
          sed -i "/^        'eventdev',/a\\        'sampler', # generic sampler library, depends on eventdev" lib/meson.build
        fi

    - name: Configure DPDK 24.11 with sampler
      run: |
        cd dpdk-24.11
        meson setup build \
          -Dexamples= \
          -Dtests=false \
          -Dmax_numa_nodes=1 \
          -Dwerror=true

    - name: Build sampler library against DPDK 24.11
      run: |
        cd dpdk-24.11
        ninja -C build lib/librte_sampler.a

    - name: Verify sampler library was built
      run: |
        cd dpdk-24.11
        ls -lh build/lib/librte_sampler.a
        file build/lib/librte_sampler.a

    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: dpdk-24-11-build-logs
        path: |
          dpdk-24.11/build/.ninja_log
          dpdk-24.11/build/meson-logs/meson-log.txt
